name: CD deployment

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, student_course]

    steps:
    - uses: actions/checkout@v3

    - name: Kubernetes deploy
      run: |
        kubectl create namespace student-course --dry-run=client -o yaml | kubectl apply -f -
        kubectl delete pod scalerpod -n student-course --ignore-not-found
        kubectl run scalerpod \
          --image=${{ secrets.DOCKERHUB_USERNAME }}/test:latest \
          -n student-course

    - name: Wait for pod to be ready
      run: |
        kubectl wait --for=condition=Ready pod/scalerpod -n student-course --timeout=120s

    - name: Port-forward application
      run: |
        kubectl port-forward pod/scalerpod 8080:8080 -n student-course &
        sleep 10

    - name: Run OWASP ZAP Baseline DAST Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:8080'
        cmd_options: '-a'
      continue-on-error: true
